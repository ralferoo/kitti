<!DOCTYPE html>
<html>
<head>
<script>

var numFilesLoaded = 0;
var people = new Object();
var log_lines = new Array();

function getAsync( url, callback ) {
    var http = new XMLHttpRequest();
    // need to always request a different URL to avoid getting a cached copy
    http.open( 'GET', url + ((/\?/).test(url) ? "&" : "?") + (new Date()).getTime(), true );
    http.onreadystatechange = function() {
        if( http.readyState==4 && http.status==200 )
        {
            callback( http.responseText );
            checkAllLoaded();
        }
    };
    http.send();
}

function storeNames( text ) {
    name_lines = text.split("\n");
    for( var i = 0; i < name_lines.length; ++i ) {
        entries = name_lines[i].split(':');
        if( entries.length < 2 ) {
            continue;
        }
        var initial = entries[0];
        people[ initial ] = new Object();
        people[ initial ].full = entries[1];
        people[ initial ].credit = 0.0;
    }
}

function storeLog( text ) {
    log_lines = text.split("\n");
}

function checkAllLoaded() {
    numFilesLoaded += 1;
    if(numFilesLoaded == 2) {
        processData();
    }
}

function requestFreshData() {
    numFilesLoaded = 0;
    people = new Object();
    log_lines = new Array();
    getAsync( "http://rawles.github.io/kitti/kittilog.txt", storeLog );
    getAsync( "http://rawles.github.io/kitti/names.txt", storeNames );
}

function parseTransaction( t ) {
    // who is mentioned on the left, and what are their weights?
    // who paid how much on the right?
    var regex_Full = /[A-Z]((\(|\[)[0-9\.]+(\)|\]))?|[0-9\.]+[A-Z]/g;
    var regex_noWeights = /[A-Z]|[0-9]+[A-Z]/g;
    var tokens = t.match( regex_noWeights );
    var totalCredited = 0.0;
    var debitors = new Array();
    console.log( t );
    for( var j = 0; j < tokens.length; ++j ) {
        var token = tokens[j];
        if( token.match( /[0-9\.]+[A-Z]+/ ) ) {
            // this is an amount credited
            console.log('Credit: '+token);
        }
        else {
            // this is a debtor
            console.log('Debit: '+token);
        }
    }
    // TODO
}

function parseLine( line ) {
    entries = line.split(/[ \t]+/); // whitespace separated
    if( entries.length >= 3 ) {
        var transaction = entries[1];
        parseTransaction( transaction );
        return transaction + "<hr>";
    }
    else {
        return line + " ??<hr>";
    }
}

function printTransactions() {
    var html = "";
    for( var i = 0; i < people.length; ++i ) {
        var person = people[i];
        html += person.full + " : " + person.credit.toString() + "<br>";
    }
    return html;
}

function processData()
{
    var log_html = "<p>";
    for( var i = 0; i < log_lines.length; ++i ) {
        log_html += parseLine( log_lines[i] );
    }
    log_html += "</p>";
    var html = printTransactions();
    document.getElementById("currentStatus").innerHTML = html;
    document.getElementById("log").innerHTML = log_html;
}

window.onload = requestFreshData;
setInterval( requestFreshData, 10000 ); // update data every 10s

</script>

<noscript>
<p>For full functionality of this site it is necessary to enable JavaScript.
Here are the <a href="http://www.enable-javascript.com/" target="_blank">
instructions how to enable JavaScript in your web browser</a>.
</p></noscript>

</head>
<body>

<div id="currentStatus">This text should have been replaced by now. Please contact Tongs Central Control for instructions.</div>

<h2>Transaction log:</h2>
<div id="log"></div>

    
</body>
</html>
