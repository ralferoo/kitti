<!DOCTYPE html>
<html>
<head>
<script>

var numFilesLoaded = 0;
var people = new Object();
var log_lines = new Array();

function getAsync( url, callback ) {
    var http = new XMLHttpRequest();
    // need to always request a different URL to avoid getting a cached copy
    http.open( 'GET', url + ((/\?/).test(url) ? "&" : "?") + (new Date()).getTime(), true );
    http.onreadystatechange = function() {
        if( http.readyState==4 && http.status==200 )
        {
            callback( http.responseText );
            checkAllLoaded();
        }
    };
    http.send();
}

function storeNames( text ) {
    name_lines = text.split("\n");
    for( var i = 0; i < name_lines.length; ++i ) {
        entries = name_lines[i].split(':');
        if( entries.length < 2 ) {
            continue;
        }
        var initial = entries[0];
        people[ initial ] = new Object();
        people[ initial ].full = entries[1];
        people[ initial ].credit = 0.0;
    }
}

function storeLog( text ) {
    log_lines = text.split("\n");
}

function checkAllLoaded() {
    numFilesLoaded += 1;
    if(numFilesLoaded == 2) {
        processData();
    }
}

function requestFreshData() {
    numFilesLoaded = 0;
    people = new Object();
    log_lines = new Array();
    getAsync( "http://rawles.github.io/kitti/kittilog.txt", storeLog );
    getAsync( "http://rawles.github.io/kitti/names.txt", storeNames );
}

function parseTransaction( t ) {
    // who is mentioned on the left, and what are their weights?
    // who paid how much on the right?
    var regex_noWeightsMatch = /^([A-Z]|[0-9\.]+[A-Z])+$/;
    var regex_noWeightsGroup = /[A-Z]|[0-9\.]+[A-Z]/g;
    if( !t.match( regex_noWeightsMatch ) ) {
        console.log( 'Unparsed transaction: ' + t );
        return false;
    }
    var tokens = t.match( regex_noWeightsGroup );
    var totalCredited = 0.0;
    var numDebitors = 0;
    console.log( t );
    console.log( tokens );
    // first parse for creditors
    for( var j = 0; j < tokens.length; ++j ) {
        var token = tokens[j];
        if( token.match( /^[0-9\.]+[A-Z]$/ ) ) {
            // this is an amount credited
            var subtokens = token.match( /[0-9.]+|[A-Z]/g );
            creditAmount = parseFloat(subtokens[0]);
            initial = subtokens[1];
            people[ initial ].credit += creditAmount;
            console.log( 'Credited '+people[ initial].full+' with '+creditAmount+' ukp.' );
            totalCredited += creditAmount;
        }
        else if( token.match( /^[A-Z]$/ ) ) {
            numDebitors++;
        }
    }
    var debtPerPerson = totalCredited / numDebitors;
    console.log( 'Total credited = '+totalCredited+', divided between '+numDebitors );
    // then parse for debtors
    for( var j = 0; j < tokens.length; ++j ) {
        var token = tokens[j];
        if( token.match( /^[A-Z]$/ ) ) {
            // this is a debtor
            initial = token;
            people[ initial ].credit -= debtPerPerson;
            console.log( 'Debited '+people[ initial].full+' with '+debtPerPerson+' ukp.' );
        }
    }
    return true;
}

function parseLine( line ) {
    var entries = line.match( /(\S+)(?:\s+)(\S+)(?:\s+)(.+)/ );
    if( entries && entries.length == 4 && parseTransaction( entries[2] ) ) {
        var timestamp = entries[1];
        var transaction = entries[2];
        var description = entries[3];
        return "Transaction=\""+transaction+"\", Description=\""+description+"\"";
    }
    else {
        return "??";
    }
}

function printStatus() {
    var html = "";
    for( var initial in people ) {
        var person = people[ initial ];
        html += person.full + " : " + person.credit.toString() + "<br>";
    }
    // TODO: sort to put lowest first
    return html;
}

function processData() {
    // show the log
    var log_html = "<table border=\"1\">";
    for( var i = 0; i < log_lines.length; ++i ) {
        var line = log_lines[i];
        log_html += "<tr><td><b>"+line+"</b></td><td>"+parseLine( line ) + "</td></tr>";
    }
    log_html += "</table>";
    document.getElementById("log").innerHTML = log_html;
    // show the status
    var html = printStatus();
    document.getElementById("currentStatus").innerHTML = html;
}

window.onload = requestFreshData;
setInterval( requestFreshData, 10000 ); // update data every 10s

</script>

<noscript>
<p>For full functionality of this site it is necessary to enable JavaScript.
Here are the <a href="http://www.enable-javascript.com/" target="_blank">
instructions how to enable JavaScript in your web browser</a>.
</p></noscript>

</head>
<body>

<div id="currentStatus">This text should have been replaced by now. Please contact Tongs Central Control for instructions.</div>

<h2>Transaction log:</h2>
<div id="log"></div>

    
</body>
</html>
