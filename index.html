<!DOCTYPE html>
<html>
<head>
<script>

var numFilesLoaded = 0;
var names = new Array();
var log_lines = new Array();

function getAsync( url, callback ) {
    var http = new XMLHttpRequest();
    // need to always request a different URL to avoid getting a cached copy
    http.open( 'GET', url + ((/\?/).test(url) ? "&" : "?") + (new Date()).getTime(), true );
    http.onreadystatechange = function() {
        if( http.readyState==4 && http.status==200 )
        {
            callback( http.responseText );
            checkAllLoaded();
        }
    };
    http.send();
}

function storeNames( text ) {
    name_lines = text.split("\n");
    for( var i = 0; i < name_lines.length; ++i ) {
        entries = name_lines[i].split(':');
        if( entries.length < 2 ) {
            continue;
        }
        var name;
        name.initial = entries[0];
        name.full = entries[1];
        name.credit = 0;
        names.push( name );
    }
}

function storeLog( text ) {
    log_lines = text.split("\n");
}

function checkAllLoaded() {
  numFilesLoaded += 1;
  if(numFilesLoaded == 2) {
     processData();
  }
}

function requestFreshData() {
  numFilesLoaded = 0;
  getAsync( "http://rawles.github.io/kitti/kittilog.txt", storeLog );
  getAsync( "http://rawles.github.io/kitti/names.txt", storeNames );
}

function parseLine( line, html, unparsed_lines ) {
    entries = line.split(/[ \t]+/); // whitespace separated
    if( entries.length < 3 ) {
        unparsed_lines.push( line );
    }
    else {
        timestamp = Date.parse( entries[0] );
        transaction = entries[1];
        description = entries[2];
        html += transaction + "<hr>";
    }
}

function processData()
{
    var unparsed_lines = new Array();
    var html = "<p>";
    for( var i = 0; i < log_lines.length; ++i ) {
        parseLine( log_lines[i], html, unparsed_lines );
    }
    html += "</p>";
    document.getElementById("myDiv").innerHTML = html;
}

window.onload = requestFreshData;
setInterval( requestFreshData, 10000 ); // update data every 10s

</script>

<noscript>
<p>For full functionality of this site it is necessary to enable JavaScript.
Here are the <a href="http://www.enable-javascript.com/" target="_blank">
instructions how to enable JavaScript in your web browser</a>.
</p></noscript>

</head>
<body>

<div id="myDiv">This text should have been replaced by now. Please contact Tongs Central Control for instructions.</div>

</body>
</html>
